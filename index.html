<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasGuard Pro - Live Prediction System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --text-dim: #94a3b8;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #1a1f3a 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--card);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status-bar {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
        }

        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .pulse.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .pulse.connecting {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .pulse.disconnected {
            background: var(--danger);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .alert-banner {
            display: none;
            padding: 1rem 2rem;
            background: var(--danger);
            color: white;
            text-align: center;
            font-weight: 600;
            animation: slideDown 0.3s ease;
        }

        .alert-banner.warning {
            background: var(--warning);
        }

        .alert-banner.info {
            background: var(--primary);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .current-value-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .current-value-card.disconnected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .disconnected-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            background: rgba(0, 0, 0, 0.7);
        }

        .disconnected-icon {
            font-size: 3rem;
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .disconnected-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .disconnected-subtext {
            font-size: 0.9rem;
            color: var(--text-dim);
            text-align: center;
            max-width: 80%;
        }

        .current-label {
            font-size: 1rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .current-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .current-unit {
            font-size: 1.5rem;
            color: var(--text-dim);
            margin-left: 0.5rem;
        }

        .current-status {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-indicator.safe {
            background: var(--success);
        }

        .status-indicator.warning {
            background: var(--warning);
        }

        .status-indicator.danger {
            background: var(--danger);
        }

        .prediction-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .prediction-card.disconnected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .prediction-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prediction-title {
            font-size: 1rem;
            color: var(--text-dim);
        }

        .prediction-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .prediction-value.safe {
            color: var(--success);
        }

        .prediction-value.warning {
            color: var(--warning);
        }

        .prediction-value.danger {
            color: var(--danger);
        }

        .prediction-value.unavailable {
            color: var(--text-dim);
        }

        .prediction-time {
            font-size: 0.875rem;
            color: var(--text-dim);
        }

        .prediction-confidence {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .chart-container {
            flex: 1;
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-height: 500px;
            position: relative;
        }

        .chart-container.disconnected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .chart-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            background: rgba(0, 0, 0, 0.7);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .control-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .control-btn.primary {
            background: var(--primary);
            color: white;
        }

        .control-btn.secondary {
            background: var(--border);
            color: var(--text);
        }

        .control-btn.danger {
            background: var(--danger);
            color: white;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .last-update {
            text-align: center;
            margin-top: 1rem;
            color: var(--text-dim);
            font-size: 0.875rem;
        }

        .retry-btn {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .retry-btn:hover {
            background: #0284c7;
        }

        .connection-info {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        @media (max-width: 1024px) {
            .metrics-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">
        <i class="fas fa-shield-alt"></i>
        <h1>GasGuard Pro - Live Prediction</h1>
    </div>
    <div class="status-bar">
        <div class="connection-status" id="connectionStatus">
            <div class="pulse" id="connectionPulse"></div>
            <span id="connectionText">Connecting...</span>
        </div>
        <div style="color: var(--text-dim); font-size: 0.875rem;">
            Last sync: <span id="lastSync">--:--</span>
        </div>
    </div>
</div>

<div class="alert-banner" id="alertBanner">
    <i class="fas fa-exclamation-triangle"></i> 
    <span id="alertMessage">Alert message here</span>
</div>

<div class="container">
    <div class="metrics-row">
        <div class="current-value-card" id="currentValueCard">
            <div class="disconnected-overlay" id="currentValueOverlay" style="display: none;">
                <i class="fas fa-wifi-slash disconnected-icon"></i>
                <div class="disconnected-text">No Data Available</div>
                <div class="disconnected-subtext">Unable to connect to ThingSpeak. Please check your connection.</div>
            </div>
            <div class="current-label">Current Gas Level</div>
            <div>
                <span class="current-value" id="currentGasValue">--</span>
                <span class="current-unit">PPM</span>
            </div>
            <div class="current-status">
                <div class="status-indicator safe" id="statusIndicator"></div>
                <span id="statusText">Safe</span>
            </div>
        </div>

        <div class="prediction-card" id="predictionCard">
            <div class="disconnected-overlay" id="predictionOverlay" style="display: none;">
                <i class="fas fa-exclamation-triangle disconnected-icon"></i>
                <div class="disconnected-text">Prediction Unavailable</div>
                <div class="disconnected-subtext">No data available for prediction</div>
            </div>
            <div class="prediction-header">
                <i class="fas fa-chart-line"></i>
                <div class="prediction-title">Prediction in 2 Hours</div>
            </div>
            <div class="prediction-value safe" id="predictionValue">--</div>
            <div class="prediction-time">Based on current trend analysis</div>
            <div class="prediction-confidence">
                <span>Confidence:</span>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                </div>
                <span id="confidenceText">--%</span>
            </div>
        </div>

        <div class="prediction-card" id="riskCard">
            <div class="disconnected-overlay" id="riskOverlay" style="display: none;">
                <i class="fas fa-question-circle disconnected-icon"></i>
                <div class="disconnected-text">Risk Unknown</div>
                <div class="disconnected-subtext">Cannot assess risk without data</div>
            </div>
            <div class="prediction-header">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="prediction-title">Risk Assessment</div>
            </div>
            <div class="prediction-value safe" id="riskLevel">Low</div>
            <div class="prediction-time" id="riskDescription">Gas levels are within safe limits</div>
        </div>
    </div>

    <div class="chart-container" id="chartContainer">
        <div class="chart-overlay" id="chartOverlay" style="display: none;">
            <i class="fas fa-chart-line disconnected-icon"></i>
            <div class="disconnected-text">No Data to Display</div>
            <div class="disconnected-subtext">Waiting for data from ThingSpeak...</div>
            <button class="retry-btn" onclick="retryConnection()">Retry Connection</button>
            <div class="connection-info" id="connectionInfo">Connection attempt failed. Will retry automatically in 30 seconds.</div>
        </div>
        <div class="chart-header">
            <h2 class="chart-title">Live Gas Level & 2-Hour Prediction</h2>
        </div>
        <div class="chart-wrapper">
            <canvas id="gasChart"></canvas>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn primary" id="ventilateBtn" onclick="sendControl('VENTILATE')">
            <i class="fas fa-fan"></i>
            Ventilate
        </button>
        <button class="control-btn secondary" onclick="refreshData()">
            <i class="fas fa-sync"></i>
            Refresh Data
        </button>
        <button class="control-btn danger" id="emergencyBtn" onclick="sendControl('EMERGENCY')">
            <i class="fas fa-exclamation-triangle"></i>
            Emergency
        </button>
    </div>

    <div class="last-update">
        Last updated: <span id="lastUpdate">--:--:--</span>
    </div>
</div>

<script>
    const CH_ID = '3221984';
    const READ_KEY = 'KXC8HUPVGG8AKVXD';
    const TB_ID = '64U4IA5216OLCOX8';
    const TB_KEY = 'AKT7J4I46XGYM7VY';
    const DANGER_THRESHOLD = 600;
    const WARNING_THRESHOLD = 400;

    let gasChart;
    let historicalData = [];
    let lastGasValue = 0;
    let connectionState = 'connecting'; // connecting, connected, disconnected
    let retryCount = 0;
    let maxRetries = 5;
    let autoRetryInterval;

    // Initialize chart
    function initChart() {
        const ctx = document.getElementById('gasChart').getContext('2d');
        gasChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Live Gas Level (PPM)',
                        data: [],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: '2-Hour Prediction',
                        data: [],
                        borderColor: '#ef4444',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Warning Level',
                        data: [],
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        borderDash: [3, 3],
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Danger Level',
                        data: [],
                        borderColor: '#dc2626',
                        borderWidth: 2,
                        borderDash: [3, 3],
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#e2e8f0',
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        titleColor: '#e2e8f0',
                        bodyColor: '#94a3b8',
                        borderColor: '#334155',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + ' PPM';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: 'HH:mm',
                                minute: 'HH:mm'
                            }
                        },
                        grid: {
                            color: 'rgba(51, 65, 85, 0.3)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#94a3b8',
                            font: {
                                size: 12
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(51, 65, 85, 0.3)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#94a3b8',
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                return value + ' PPM';
                            }
                        }
                    }
                }
            }
        });
    }

    // Fetch and update data
    async function updateData() {
        if (connectionState === 'connecting') {
            updateConnectionStatus('connecting');
        }

        try {
            const response = await fetch(`https://api.thingspeak.com/channels/${CH_ID}/feeds.json?api_key=${READ_KEY}&results=20`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.feeds && data.feeds.length > 0) {
                processFeeds(data.feeds);
                updateMetrics();
                updateChart();
                generatePrediction();
                updateConnectionStatus('connected');
                retryCount = 0;
                hideDisconnectedOverlays();
                enableControls();
            } else {
                throw new Error('No data received from ThingSpeak');
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            updateConnectionStatus('disconnected');
            showDisconnectedOverlays();
            disableControls();
            handleRetry();
        }
    }

    function processFeeds(feeds) {
        historicalData = feeds
            .filter(feed => feed.field1 && !isNaN(parseFloat(feed.field1)))
            .map(feed => ({
                timestamp: new Date(feed.created_at),
                value: parseFloat(feed.field1),
                fire: feed.field2
            }))
            .reverse();
    }

    function updateMetrics() {
        if (historicalData.length === 0) return;

        const latest = historicalData[historicalData.length - 1];
        const gasValue = latest.value;
        
        // Update current value
        document.getElementById('currentGasValue').textContent = gasValue.toFixed(1);
        
        // Update status
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        if (gasValue > DANGER_THRESHOLD) {
            statusIndicator.className = 'status-indicator danger';
            statusText.textContent = 'Danger';
            showAlert(`DANGER: Gas level ${gasValue.toFixed(1)} PPM exceeds safe limit!`, 'danger');
        } else if (gasValue > WARNING_THRESHOLD) {
            statusIndicator.className = 'status-indicator warning';
            statusText.textContent = 'Warning';
            showAlert(`WARNING: Gas level elevated at ${gasValue.toFixed(1)} PPM`, 'warning');
        } else {
            statusIndicator.className = 'status-indicator safe';
            statusText.textContent = 'Safe';
        }
        
        // Update last sync and update time
        const now = new Date();
        document.getElementById('lastSync').textContent = now.toLocaleTimeString();
        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
    }

    function updateChart() {
        if (!gasChart || historicalData.length === 0) return;
        
        // Get data from the last 6 hours
        const now = new Date();
        const sixHoursAgo = new Date(now.getTime() - 6 * 60 * 60 * 1000);
        const filteredData = historicalData.filter(d => d.timestamp >= sixHoursAgo);
        
        // Update historical data
        gasChart.data.datasets[0].data = filteredData.map(d => ({
            x: d.timestamp,
            y: d.value
        }));
        
        // Update threshold lines
        gasChart.data.datasets[2].data = filteredData.map(d => ({
            x: d.timestamp,
            y: WARNING_THRESHOLD
        }));
        
        gasChart.data.datasets[3].data = filteredData.map(d => ({
            x: d.timestamp,
            y: DANGER_THRESHOLD
        }));
        
        gasChart.update();
    }

    function generatePrediction() {
        if (historicalData.length < 5) return;
        
        // Use more data points for better prediction
        const recent = historicalData.slice(-15);
        const n = recent.length;
        const x = Array.from({length: n}, (_, i) => i);
        const y = recent.map(d => d.value);
        
        // Calculate linear regression
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        for (let i = 0; i < n; i++) {
            sumX += x[i];
            sumY += y[i];
            sumXY += x[i] * y[i];
            sumX2 += x[i] * x[i];
        }
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        // Calculate R-squared for confidence
        let yMean = sumY / n;
        let ssTotal = 0, ssResidual = 0;
        for (let i = 0; i < n; i++) {
            const yPred = slope * x[i] + intercept;
            ssTotal += Math.pow(y[i] - yMean, 2);
            ssResidual += Math.pow(y[i] - yPred, 2);
        }
        const rSquared = 1 - (ssResidual / ssTotal);
        const confidence = Math.min(95, Math.max(50, rSquared * 100));
        
        // Generate predictions for next 2 hours (40 points at 3-minute intervals)
        const predictions = [];
        const now = new Date();
        for (let i = 1; i <= 40; i++) {
            const futureTime = new Date(now.getTime() + i * 3 * 60 * 1000);
            const predictedValue = slope * (n + i) + intercept;
            predictions.push({
                x: futureTime,
                y: Math.max(0, predictedValue)
            });
        }
        
        // Update prediction dataset
        gasChart.data.datasets[1].data = predictions;
        gasChart.update();
        
        // Update prediction card
        if (predictions.length > 0) {
            const predictionAt2Hours = predictions[predictions.length - 1].y;
            const predictionValueElement = document.getElementById('predictionValue');
            predictionValueElement.textContent = predictionAt2Hours.toFixed(1) + ' PPM';
            
            // Update prediction status
            if (predictionAt2Hours > DANGER_THRESHOLD) {
                predictionValueElement.className = 'prediction-value danger';
            } else if (predictionAt2Hours > WARNING_THRESHOLD) {
                predictionValueElement.className = 'prediction-value warning';
            } else {
                predictionValueElement.className = 'prediction-value safe';
            }
            
            // Update confidence
            document.getElementById('confidenceFill').style.width = confidence + '%';
            document.getElementById('confidenceText').textContent = confidence.toFixed(0) + '%';
            
            // Update risk assessment
            updateRiskAssessment(predictionAt2Hours, confidence);
        }
    }

    function updateRiskAssessment(predictionValue, confidence) {
        const riskLevelElement = document.getElementById('riskLevel');
        const riskDescriptionElement = document.getElementById('riskDescription');
        
        if (predictionValue > DANGER_THRESHOLD) {
            riskLevelElement.textContent = 'High';
            riskLevelElement.className = 'prediction-value danger';
            riskDescriptionElement.textContent = 'Dangerous levels expected in 2 hours';
        } else if (predictionValue > WARNING_THRESHOLD) {
            riskLevelElement.textContent = 'Medium';
            riskLevelElement.className = 'prediction-value warning';
            riskDescriptionElement.textContent = 'Warning levels expected in 2 hours';
        } else {
            riskLevelElement.textContent = 'Low';
            riskLevelElement.className = 'prediction-value safe';
            riskDescriptionElement.textContent = 'Gas levels are expected to remain safe';
        }
        
        // Add confidence to description
        riskDescriptionElement.textContent += ` (${confidence.toFixed(0)}% confidence)`;
    }

    function showAlert(message, type) {
        const banner = document.getElementById('alertBanner');
        const messageElement = document.getElementById('alertMessage');
        
        banner.className = 'alert-banner';
        if (type === 'warning') banner.classList.add('warning');
        if (type === 'info') banner.classList.add('info');
        
        messageElement.textContent = message;
        banner.style.display = 'block';
        
        setTimeout(() => {
            banner.style.display = 'none';
        }, 5000);
    }

    function updateConnectionStatus(status) {
        connectionState = status;
        const statusElement = document.getElementById('connectionStatus');
        const pulseElement = document.getElementById('connectionPulse');
        const textElement = document.getElementById('connectionText');
        
        statusElement.className = 'connection-status ' + status;
        pulseElement.className = 'pulse ' + status;
        
        switch(status) {
            case 'connected':
                textElement.textContent = 'Connected';
                break;
            case 'connecting':
                textElement.textContent = 'Connecting...';
                break;
            case 'disconnected':
                textElement.textContent = 'Disconnected';
                break;
        }
    }

    function showDisconnectedOverlays() {
        document.getElementById('currentValueOverlay').style.display = 'flex';
        document.getElementById('predictionOverlay').style.display = 'flex';
        document.getElementById('riskOverlay').style.display = 'flex';
        document.getElementById('chartOverlay').style.display = 'flex';
        
        document.getElementById('currentValueCard').classList.add('disconnected');
        document.getElementById('predictionCard').classList.add('disconnected');
        document.getElementById('riskCard').classList.add('disconnected');
        document.getElementById('chartContainer').classList.add('disconnected');
    }

    function hideDisconnectedOverlays() {
        document.getElementById('currentValueOverlay').style.display = 'none';
        document.getElementById('predictionOverlay').style.display = 'none';
        document.getElementById('riskOverlay').style.display = 'none';
        document.getElementById('chartOverlay').style.display = 'none';
        
        document.getElementById('currentValueCard').classList.remove('disconnected');
        document.getElementById('predictionCard').classList.remove('disconnected');
        document.getElementById('riskCard').classList.remove('disconnected');
        document.getElementById('chartContainer').classList.remove('disconnected');
    }

    function disableControls() {
        document.getElementById('ventilateBtn').disabled = true;
        document.getElementById('emergencyBtn').disabled = true;
    }

    function enableControls() {
        document.getElementById('ventilateBtn').disabled = false;
        document.getElementById('emergencyBtn').disabled = false;
    }

    function handleRetry() {
        retryCount++;
        
        if (retryCount <= maxRetries) {
            const retrySeconds = 30;
            document.getElementById('connectionInfo').textContent = 
                `Connection attempt failed. Will retry automatically in ${retrySeconds} seconds.`;
            
            clearInterval(autoRetryInterval);
            autoRetryInterval = setTimeout(() => {
                updateData();
            }, retrySeconds * 1000);
        } else {
            document.getElementById('connectionInfo').textContent = 
                'Multiple connection attempts failed. Please check your connection and try manually.';
        }
    }

    function retryConnection() {
        retryCount = 0;
        updateConnectionStatus('connecting');
        updateData();
    }

    async function sendControl(command) {
        if (connectionState !== 'connected') {
            showAlert('Cannot send command: Not connected to ThingSpeak', 'warning');
            return;
        }

        try {
            const response = await fetch(`https://api.thingspeak.com/talkbacks/${TB_ID}/commands.json?api_key=${TB_KEY}&command_string=${command}`, {
                method: 'POST'
            });
            
            if (response.ok) {
                // Show appropriate feedback
                switch(command) {
                    case 'VENTILATE':
                        showAlert('Ventilation system activated', 'info');
                        break;
                    case 'EMERGENCY':
                        showAlert('Emergency protocol activated!', 'danger');
                        break;
                }
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('Error sending command:', error);
            showAlert('Network error - command not sent', 'danger');
        }
    }

    function refreshData() {
        updateConnectionStatus('connecting');
        updateData();
    }

    // Initialize
    initChart();
    updateData();
    
    // Update every 30 seconds
    setInterval(() => {
        if (connectionState === 'connected') {
            updateData();
        }
    }, 30000);
</script>

</body>
</html>
