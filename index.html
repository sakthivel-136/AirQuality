<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasGuard Pro - Health & Safety Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --health-low: #10b981;
            --health-moderate: #f59e0b;
            --health-high: #ef4444;
            --health-severe: #dc2626;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #1a1f3a 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--card);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status-bar {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
        }

        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .pulse.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .pulse.connecting {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .pulse.disconnected {
            background: var(--danger);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .health-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .health-popup.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .health-popup-content {
            background: var(--card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .health-popup.active .health-popup-content {
            transform: scale(1);
        }

        .health-popup-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .health-popup-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .health-popup-icon.low {
            background: rgba(16, 185, 129, 0.1);
            color: var(--health-low);
        }

        .health-popup-icon.moderate {
            background: rgba(245, 158, 11, 0.1);
            color: var(--health-moderate);
        }

        .health-popup-icon.high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--health-high);
        }

        .health-popup-icon.severe {
            background: rgba(220, 38, 38, 0.1);
            color: var(--health-severe);
        }

        .health-popup-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .health-popup-message {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .health-popup-recommendations {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .health-popup-recommendations h4 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .health-popup-recommendations ul {
            padding-left: 1.5rem;
        }

        .health-popup-recommendations li {
            margin-bottom: 0.5rem;
        }

        .health-popup-close {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .health-popup-close:hover {
            background: #0284c7;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .current-value-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .current-value-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .current-value-card.disconnected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .disconnected-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            background: rgba(0, 0, 0, 0.7);
        }

        .disconnected-icon {
            font-size: 3rem;
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .disconnected-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .disconnected-subtext {
            font-size: 0.9rem;
            color: var(--text-dim);
            text-align: center;
            max-width: 80%;
        }

        .current-label {
            font-size: 1rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .current-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .current-unit {
            font-size: 1.5rem;
            color: var(--text-dim);
            margin-left: 0.5rem;
        }

        .current-status {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-indicator.safe {
            background: var(--success);
        }

        .status-indicator.warning {
            background: var(--warning);
        }

        .status-indicator.danger {
            background: var(--danger);
        }

        .prediction-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .prediction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .prediction-card.disconnected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .prediction-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prediction-title {
            font-size: 1rem;
            color: var(--text-dim);
        }

        .prediction-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .prediction-value.safe {
            color: var(--success);
        }

        .prediction-value.warning {
            color: var(--warning);
        }

        .prediction-value.danger {
            color: var(--danger);
        }

        .prediction-value.unavailable {
            color: var(--text-dim);
        }

        .prediction-time {
            font-size: 0.875rem;
            color: var(--text-dim);
        }

        .prediction-confidence {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .chart-container {
            flex: 1;
            background: var(--card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-height: 500px;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .chart-container.disconnected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .chart-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            background: rgba(0, 0, 0, 0.7);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
        }

        .prediction-display {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(14, 165, 233, 0.05));
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prediction-display-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dim);
        }

        .prediction-display-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .prediction-display-time {
            font-size: 0.875rem;
            color: var(--text-dim);
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .control-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .control-btn.primary {
            background: var(--primary);
            color: white;
        }

        .control-btn.secondary {
            background: var(--border);
            color: var(--text);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .last-update {
            text-align: center;
            margin-top: 1rem;
            color: var(--text-dim);
            font-size: 0.875rem;
        }

        .retry-btn {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .retry-btn:hover {
            background: #0284c7;
        }

        .connection-info {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .prediction-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .prediction-status i {
            font-size: 1rem;
        }

        .prediction-status.valid {
            color: var(--success);
        }

        .prediction-status.invalid {
            color: var(--warning);
        }

        .health-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .health-indicator:hover {
            transform: scale(1.1);
        }

        .health-indicator.low {
            background: rgba(16, 185, 129, 0.1);
            color: var(--health-low);
        }

        .health-indicator.moderate {
            background: rgba(245, 158, 11, 0.1);
            color: var(--health-moderate);
        }

        .health-indicator.high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--health-high);
        }

        .health-indicator.severe {
            background: rgba(220, 38, 38, 0.1);
            color: var(--health-severe);
        }

        .report-container {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-top: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .report-header {
            padding: 1.5rem;
            background: rgba(14, 165, 233, 0.1);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-header:hover {
            background: rgba(14, 165, 233, 0.15);
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .report-toggle {
            transition: transform 0.3s ease;
        }

        .report-toggle.expanded {
            transform: rotate(180deg);
        }

        .report-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .report-content.expanded {
            padding: 1.5rem;
            max-height: 1000px;
        }

        .report-section {
            margin-bottom: 1.5rem;
        }

        .report-section:last-child {
            margin-bottom: 0;
        }

        .report-section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .health-impact {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid var(--success);
        }

        .health-impact.moderate {
            border-left-color: var(--warning);
        }

        .health-impact.high {
            border-left-color: var(--danger);
        }

        .health-impact.severe {
            border-left-color: var(--health-severe);
        }

        .health-impact-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .health-impact-message {
            color: var(--text-dim);
            margin-bottom: 1rem;
        }

        .health-impact-recommendations {
            font-size: 0.875rem;
        }

        .health-impact-recommendations h5 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .health-impact-recommendations ul {
            padding-left: 1.5rem;
        }

        .health-impact-recommendations li {
            margin-bottom: 0.25rem;
            color: var(--text-dim);
        }

        .prediction-analysis {
            background: rgba(14, 165, 233, 0.05);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(14, 165, 233, 0.2);
        }

        .prediction-analysis-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .prediction-analysis-item:last-child {
            margin-bottom: 0;
        }

        .prediction-analysis-label {
            color: var(--text-dim);
        }

        .prediction-analysis-value {
            font-weight: 600;
        }

        .data-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .trend-arrow {
            font-size: 1rem;
        }

        .trend-arrow.up {
            color: var(--danger);
        }

        .trend-arrow.down {
            color: var(--success);
        }

        .trend-arrow.stable {
            color: var(--text-dim);
        }

        @media (max-width: 1024px) {
            .metrics-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">
        <i class="fas fa-shield-alt"></i>
        <h1>GasGuard Pro - Health & Safety Monitor</h1>
    </div>
    <div class="status-bar">
        <div class="connection-status" id="connectionStatus">
            <div class="pulse" id="connectionPulse"></div>
            <span id="connectionText">Connecting...</span>
        </div>
        <div style="color: var(--text-dim); font-size: 0.875rem;">
            Last sync: <span id="lastSync">--:--</span>
        </div>
    </div>
</div>

<div class="health-popup" id="healthPopup">
    <div class="health-popup-content">
        <div class="health-popup-header">
            <div class="health-popup-icon" id="healthPopupIcon">
                <i class="fas fa-heart"></i>
            </div>
            <h2 class="health-popup-title" id="healthPopupTitle">Health Alert</h2>
        </div>
        <div class="health-popup-message" id="healthPopupMessage">
            Message about health risks
        </div>
        <div class="health-popup-recommendations">
            <h4>Recommendations:</h4>
            <ul id="healthPopupRecommendations">
                <li>Recommendation 1</li>
                <li>Recommendation 2</li>
                <li>Recommendation 3</li>
            </ul>
        </div>
        <button class="health-popup-close" onclick="closeHealthPopup()">I Understand</button>
    </div>
</div>

<div class="container">
    <div class="metrics-row">
        <div class="current-value-card" id="currentValueCard">
            <div class="disconnected-overlay" id="currentValueOverlay" style="display: none;">
                <i class="fas fa-wifi-slash disconnected-icon"></i>
                <div class="disconnected-text">No Data Available</div>
                <div class="disconnected-subtext">Unable to connect to ThingSpeak. Please check your connection.</div>
            </div>
            <div class="health-indicator" id="healthIndicator" onclick="showHealthDetails()">
                <i class="fas fa-heart"></i>
            </div>
            <div class="current-label">Current Gas Level</div>
            <div>
                <span class="current-value" id="currentGasValue">--</span>
                <span class="current-unit">PPM</span>
            </div>
            <div class="current-status">
                <div class="status-indicator safe" id="statusIndicator"></div>
                <span id="statusText">Safe</span>
            </div>
        </div>

        <div class="prediction-card" id="predictionCard">
            <div class="disconnected-overlay" id="predictionOverlay" style="display: none;">
                <i class="fas fa-exclamation-triangle disconnected-icon"></i>
                <div class="disconnected-text">Prediction Unavailable</div>
                <div class="disconnected-subtext">No data available for prediction</div>
            </div>
            <div class="prediction-header">
                <i class="fas fa-chart-line"></i>
                <div class="prediction-title">Prediction in 2 Hours</div>
            </div>
            <div class="prediction-value safe" id="predictionValue">--</div>
            <div class="prediction-time">Based on current trend analysis</div>
            <div class="prediction-status" id="predictionStatus">
                <i class="fas fa-check-circle"></i>
                <span>Ready to calculate</span>
            </div>
            <div class="prediction-confidence">
                <span>Confidence:</span>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                </div>
                <span id="confidenceText">--%</span>
            </div>
        </div>

        <div class="prediction-card" id="riskCard">
            <div class="disconnected-overlay" id="riskOverlay" style="display: none;">
                <i class="fas fa-question-circle disconnected-icon"></i>
                <div class="disconnected-text">Risk Unknown</div>
                <div class="disconnected-subtext">Cannot assess risk without data</div>
            </div>
            <div class="prediction-header">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="prediction-title">Risk Assessment</div>
            </div>
            <div class="prediction-value safe" id="riskLevel">Low</div>
            <div class="prediction-time" id="riskDescription">Gas levels are within safe limits</div>
        </div>
    </div>

    <div class="prediction-display" id="predictionDisplay">
        <div>
            <div class="prediction-display-title">AI Prediction for Next 2 Hours</div>
            <div class="prediction-display-time">Based on current trend analysis</div>
        </div>
        <div style="text-align: right;">
            <div class="prediction-display-value" id="predictionDisplayValue">-- PPM</div>
            <div class="prediction-time">Confidence: <span id="predictionDisplayConfidence">--%</span></div>
        </div>
    </div>

    <div class="chart-container" id="chartContainer">
        <div class="chart-overlay" id="chartOverlay" style="display: none;">
            <i class="fas fa-chart-line disconnected-icon"></i>
            <div class="disconnected-text">No Data to Display</div>
            <div class="disconnected-subtext">Waiting for data from ThingSpeak...</div>
            <button class="retry-btn" onclick="retryConnection()">Retry Connection</button>
            <div class="connection-info" id="connectionInfo">Connection attempt failed. Will retry automatically in 30 seconds.</div>
        </div>
        <div class="chart-header">
            <h2 class="chart-title">Live Gas Level Trends</h2>
        </div>
        <div class="chart-wrapper">
            <canvas id="gasChart"></canvas>
        </div>
    </div>

    <div class="report-container" id="reportContainer">
        <div class="report-header" onclick="toggleReport()">
            <div class="report-title">
                <i class="fas fa-file-alt"></i>
                Analytic Report
            </div>
            <i class="fas fa-chevron-down report-toggle" id="reportToggle"></i>
        </div>
        <div class="report-content" id="reportContent">
            <div class="report-section">
                <h3 class="report-section-title">
                    <i class="fas fa-chart-bar"></i>
                    Summary Statistics
                </h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Period</div>
                        <div class="stat-value" id="reportPeriod">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Data Points</div>
                        <div class="stat-value" id="reportDataPoints">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Minimum Level</div>
                        <div class="stat-value" id="reportMin">-- PPM</div>
                        <div class="data-trend" id="minTrend"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Maximum Level</div>
                        <div class="stat-value" id="reportMax">-- PPM</div>
                        <div class="data-trend" id="maxTrend"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Average Level</div>
                        <div class="stat-value" id="reportAvg">-- PPM</div>
                        <div class="data-trend" id="avgTrend"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Risk Level</div>
                        <div class="stat-value" id="reportRisk">--</div>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h3 class="report-section-title">
                    <i class="fas fa-heartbeat"></i>
                    Health Impact Assessment
                </h3>
                <div class="health-impact" id="healthImpact">
                    <div class="health-impact-title" id="healthImpactTitle">Loading...</div>
                    <div class="health-impact-message" id="healthImpactMessage">Analyzing data...</div>
                    <div class="health-impact-recommendations">
                        <h5>Recommendations:</h5>
                        <ul id="healthImpactRecommendations">
                            <li>Loading recommendations...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h3 class="report-section-title">
                    <i class="fas fa-brain"></i>
                    Prediction Analysis
                </h3>
                <div class="prediction-analysis" id="predictionAnalysis">
                    <div class="prediction-analysis-item">
                        <span class="prediction-analysis-label">Predicted Level in 2 Hours:</span>
                        <span class="prediction-analysis-value" id="predAnalysisLevel">-- PPM</span>
                    </div>
                    <div class="prediction-analysis-item">
                        <span class="prediction-analysis-label">Prediction Confidence:</span>
                        <span class="prediction-analysis-value" id="predAnalysisConfidence">--%</span>
                    </div>
                    <div class="prediction-analysis-item">
                        <span class="prediction-analysis-label">Trend Direction:</span>
                        <span class="prediction-analysis-value" id="predAnalysisTrend">--</span>
                    </div>
                    <div class="prediction-analysis-item">
                        <span class="prediction-analysis-label">Rate of Change:</span>
                        <span class="prediction-analysis-value" id="predAnalysisRate">-- PPM/hr</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn primary" id="downloadBtn" onclick="downloadData()">
            <i class="fas fa-download"></i>
            Download Data
        </button>
        <button class="control-btn secondary" id="refreshBtn" onclick="refreshData()">
            <i class="fas fa-sync"></i>
            Refresh Data
        </button>
    </div>

    <div class="last-update">
        Last updated: <span id="lastUpdate">--:--:--</span>
    </div>
</div>

<script>
    const CH_ID = '3221984';
    const READ_KEY = 'KXC8HUPVGG8AKVXD';
    const TB_ID = '64U4IA5216OLCOX8';
    const TB_KEY = 'AKT7J4I46XGYM7VY';
    const DANGER_THRESHOLD = 600;
    const WARNING_THRESHOLD = 400;
    const MIN_DATA_POINTS = 5;
    const MAX_DATA_POINTS = 20;

    let gasChart;
    let historicalData = [];
    let lastGasValue = 0;
    let connectionState = 'connecting'; // connecting, connected, disconnected
    let retryCount = 0;
    let maxRetries = 5;
    let autoRetryInterval;
    let predictionData = null;
    let lastHealthAlertLevel = null;
    let previousStats = null; // Store previous statistics for trend comparison

    // Health risk levels and recommendations
    const healthRisks = {
        low: {
            threshold: 50,
            title: "Good Air Quality",
            message: "Current gas levels are within safe limits for all individuals, including those with respiratory conditions.",
            recommendations: [
                "Continue normal activities",
                "Maintain good ventilation practices",
                "Monitor levels periodically"
            ]
        },
        moderate: {
            threshold: 200,
            title: "Moderate Air Quality",
            message: "Gas levels may cause minor discomfort for sensitive individuals, including those with asthma or other respiratory conditions.",
            recommendations: [
                "Consider limiting prolonged outdoor activities",
                "Ensure proper ventilation in indoor spaces",
                "Individuals with asthma should keep medication readily available"
            ]
        },
        high: {
            threshold: 400,
            title: "Poor Air Quality",
            message: "Gas levels may cause health effects for sensitive individuals and could cause discomfort for the general population.",
            recommendations: [
                "Limit outdoor activities, especially for sensitive groups",
                "Keep windows closed and use air purifiers if available",
                "Individuals with respiratory conditions should avoid outdoor exertion"
            ]
        },
        severe: {
            threshold: 600,
            title: "Hazardous Air Quality",
            message: "Gas levels at this range pose serious health risks to all individuals, particularly those with respiratory conditions.",
            recommendations: [
                "Avoid all outdoor activities",
                "Stay indoors with windows and doors closed",
                "Use air purifiers if available",
                "Seek medical attention if experiencing symptoms like difficulty breathing"
            ]
        }
    };

    // Initialize chart
    function initChart() {
        const ctx = document.getElementById('gasChart').getContext('2d');
        gasChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Live Gas Level (PPM)',
                        data: [],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Warning Level',
                        data: [],
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        borderDash: [3, 3],
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Danger Level',
                        data: [],
                        borderColor: '#dc2626',
                        borderWidth: 2,
                        borderDash: [3, 3],
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#e2e8f0',
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        titleColor: '#e2e8f0',
                        bodyColor: '#94a3b8',
                        borderColor: '#334155',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + ' PPM';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: 'HH:mm',
                                minute: 'HH:mm'
                            }
                        },
                        grid: {
                            color: 'rgba(51, 65, 85, 0.3)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#94a3b8',
                            font: {
                                size: 12
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(51, 65, 85, 0.3)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#94a3b8',
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                return value + ' PPM';
                            }
                        }
                    }
                }
            }
        });
    }

    // Improved linear regression with error handling
    function calculateLinearRegression(x, y) {
        if (x.length !== y.length || x.length < MIN_DATA_POINTS) {
            return null;
        }

        const n = x.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        
        for (let i = 0; i < n; i++) {
            sumX += x[i];
            sumY += y[i];
            sumXY += x[i] * y[i];
            sumX2 += x[i] * x[i];
        }

        const denominator = n * sumX2 - sumX * sumX;
        
        // Check for division by zero
        if (Math.abs(denominator) < 0.0001) {
            console.warn('Linear regression: Denominator too small');
            return null;
        }

        const slope = (n * sumXY - sumX * sumY) / denominator;
        const intercept = (sumY - slope * sumX) / n;

        // Calculate R-squared for confidence
        let yMean = sumY / n;
        let ssTotal = 0, ssResidual = 0;
        
        for (let i = 0; i < n; i++) {
            const yPred = slope * x[i] + intercept;
            ssTotal += Math.pow(y[i] - yMean, 2);
            ssResidual += Math.pow(y[i] - yPred, 2);
        }

        const rSquared = ssTotal > 0 ? 1 - (ssResidual / ssTotal) : 0;
        const confidence = Math.min(95, Math.max(30, rSquared * 100));

        return { slope, intercept, confidence, rSquared };
    }

    // Improved prediction generation
    function generatePrediction() {
        const predictionStatus = document.getElementById('predictionStatus');
        
        if (historicalData.length < MIN_DATA_POINTS) {
            predictionStatus.className = 'prediction-status invalid';
            predictionStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Insufficient data</span>';
            resetPrediction();
            return;
        }

        // Use the most recent data points
        const recent = historicalData.slice(-MAX_DATA_POINTS);
        const n = recent.length;
        const x = Array.from({length: n}, (_, i) => i);
        const y = recent.map(d => d.value);

        // Check for data consistency
        const yVariance = calculateVariance(y);
        if (yVariance < 1) {
            predictionStatus.className = 'prediction-status invalid';
            predictionStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Data too stable</span>';
            resetPrediction();
            return;
        }

        const regression = calculateLinearRegression(x, y);
        
        if (!regression) {
            predictionStatus.className = 'prediction-status invalid';
            predictionStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Cannot calculate trend</span>';
            resetPrediction();
            return;
        }

        // Generate predictions for next 2 hours (40 points at 3-minute intervals)
        const predictions = [];
        const now = new Date();
        let maxPrediction = 0;
        
        for (let i = 1; i <= 40; i++) {
            const futureTime = new Date(now.getTime() + i * 3 * 60 * 1000);
            const predictedValue = regression.slope * (n + i) + regression.intercept;
            const clampedValue = Math.max(0, predictedValue);
            predictions.push({
                x: futureTime,
                y: clampedValue
            });
            maxPrediction = Math.max(maxPrediction, clampedValue);
        }

        // Store prediction data
        predictionData = {
            predictions,
            confidence: regression.confidence,
            maxPrediction,
            slope: regression.slope,
            rateOfChange: regression.slope * 20 // PPM per hour (3 min intervals * 20)
        };

        // Update UI
        updatePredictionUI();
        predictionStatus.className = 'prediction-status valid';
        predictionStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>Prediction calculated</span>';
        
        // Update report
        updateReport();
    }

    function calculateVariance(values) {
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        return values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
    }

    function resetPrediction() {
        predictionData = null;
        document.getElementById('predictionValue').textContent = '--';
        document.getElementById('predictionDisplayValue').textContent = '-- PPM';
        document.getElementById('confidenceFill').style.width = '0%';
        document.getElementById('confidenceText').textContent = '--%';
        document.getElementById('predictionDisplayConfidence').textContent = '--%';
        document.getElementById('riskLevel').textContent = 'Low';
        document.getElementById('riskDescription').textContent = 'Cannot assess risk';
    }

    function updatePredictionUI() {
        if (!predictionData) return;

        const { predictions, confidence, maxPrediction, slope } = predictionData;
        
        // Update prediction value
        const predictionValueElement = document.getElementById('predictionValue');
        const finalPrediction = predictions[predictions.length - 1].y;
        predictionValueElement.textContent = finalPrediction.toFixed(1) + ' PPM';
        
        // Update prediction display
        document.getElementById('predictionDisplayValue').textContent = finalPrediction.toFixed(1) + ' PPM';
        document.getElementById('predictionDisplayConfidence').textContent = confidence.toFixed(0) + '%';
        
        // Update prediction status color
        if (finalPrediction > DANGER_THRESHOLD) {
            predictionValueElement.className = 'prediction-value danger';
        } else if (finalPrediction > WARNING_THRESHOLD) {
            predictionValueElement.className = 'prediction-value warning';
        } else {
            predictionValueElement.className = 'prediction-value safe';
        }
        
        // Update confidence
        document.getElementById('confidenceFill').style.width = confidence + '%';
        document.getElementById('confidenceText').textContent = confidence.toFixed(0) + '%';
        
        // Update risk assessment
        updateRiskAssessment(finalPrediction, confidence, slope);
    }

    function updateRiskAssessment(predictionValue, confidence, slope) {
        const riskLevelElement = document.getElementById('riskLevel');
        const riskDescriptionElement = document.getElementById('riskDescription');
        
        let riskLevel = 'Low';
        let riskDescription = 'Gas levels are expected to remain safe';
        let riskColor = 'safe';
        
        if (predictionValue > DANGER_THRESHOLD) {
            riskLevel = 'High';
            riskDescription = 'Dangerous levels expected in 2 hours';
            riskColor = 'danger';
        } else if (predictionValue > WARNING_THRESHOLD) {
            riskLevel = 'Medium';
            riskDescription = 'Warning levels expected in 2 hours';
            riskColor = 'warning';
        } else if (Math.abs(slope) > 5) {
            riskLevel = 'Moderate';
            riskDescription = 'Rapid changes detected - monitor closely';
            riskColor = 'warning';
        }
        
        riskLevelElement.textContent = riskLevel;
        riskLevelElement.className = 'prediction-value ' + riskColor;
        riskDescriptionElement.textContent = `${riskDescription} (${confidence.toFixed(0)}% confidence)`;
    }

    function updateReport() {
        if (historicalData.length === 0) return;
        
        // Calculate statistics based on real-time data
        const values = historicalData.map(d => d.value);
        const min = Math.min(...values);
        const max = Math.max(...values);
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        
        // Store current stats for trend comparison
        const currentStats = { min, max, avg, dataPoints: historicalData.length };
        
        // Update summary statistics with real data
        document.getElementById('reportPeriod').textContent = 
            `${historicalData[0].timestamp.toLocaleDateString()} - ${historicalData[historicalData.length-1].timestamp.toLocaleDateString()}`;
        document.getElementById('reportDataPoints').textContent = historicalData.length;
        document.getElementById('reportMin').textContent = min.toFixed(2) + ' PPM';
        document.getElementById('reportMax').textContent = max.toFixed(2) + ' PPM';
        document.getElementById('reportAvg').textContent = avg.toFixed(2) + ' PPM';
        
        // Determine risk level based on real data
        let riskLevel = 'Low';
        let riskColor = '#10b981';
        if (avg > DANGER_THRESHOLD) {
            riskLevel = 'High';
            riskColor = '#ef4444';
        } else if (avg > WARNING_THRESHOLD) {
            riskLevel = 'Medium';
            riskColor = '#f59e0b';
        }
        document.getElementById('reportRisk').textContent = riskLevel;
        document.getElementById('reportRisk').style.color = riskColor;
        
        // Update trends if we have previous data
        if (previousStats) {
            updateTrendIndicators(currentStats, previousStats);
        }
        
        // Store current stats for next comparison
        previousStats = currentStats;
        
        // Update health impact based on real data
        updateHealthImpact(avg);
        
        // Update prediction analysis
        if (predictionData) {
            document.getElementById('predAnalysisLevel').textContent = predictionData.maxPrediction.toFixed(2) + ' PPM';
            document.getElementById('predAnalysisConfidence').textContent = predictionData.confidence.toFixed(0) + '%';
            document.getElementById('predAnalysisTrend').textContent = 
                predictionData.slope > 0 ? 'Increasing' : predictionData.slope < 0 ? 'Decreasing' : 'Stable';
            document.getElementById('predAnalysisRate').textContent = 
                (predictionData.rateOfChange > 0 ? '+' : '') + predictionData.rateOfChange.toFixed(2) + ' PPM/hr';
        } else {
            document.getElementById('predAnalysisLevel').textContent = 'Not available';
            document.getElementById('predAnalysisConfidence').textContent = '--';
            document.getElementById('predAnalysisTrend').textContent = '--';
            document.getElementById('predAnalysisRate').textContent = '--';
        }
    }

    function updateTrendIndicators(current, previous) {
        // Update min trend
        const minTrend = document.getElementById('minTrend');
        const minChange = current.min - previous.min;
        if (minChange > 0) {
            minTrend.innerHTML = '<i class="fas fa-arrow-up trend-arrow up"></i><span>+' + minChange.toFixed(1) + ' PPM</span>';
        } else if (minChange < 0) {
            minTrend.innerHTML = '<i class="fas fa-arrow-down trend-arrow down"></i><span>' + minChange.toFixed(1) + ' PPM</span>';
        } else {
            minTrend.innerHTML = '<i class="fas fa-minus trend-arrow stable"></i><span>No change</span>';
        }
        
        // Update max trend
        const maxTrend = document.getElementById('maxTrend');
        const maxChange = current.max - previous.max;
        if (maxChange > 0) {
            maxTrend.innerHTML = '<i class="fas fa-arrow-up trend-arrow up"></i><span>+' + maxChange.toFixed(1) + ' PPM</span>';
        } else if (maxChange < 0) {
            maxTrend.innerHTML = '<i class="fas fa-arrow-down trend-arrow down"></i><span>' + maxChange.toFixed(1) + ' PPM</span>';
        } else {
            maxTrend.innerHTML = '<i class="fas fa-minus trend-arrow stable"></i><span>No change</span>';
        }
        
        // Update average trend
        const avgTrend = document.getElementById('avgTrend');
        const avgChange = current.avg - previous.avg;
        if (avgChange > 0) {
            avgTrend.innerHTML = '<i class="fas fa-arrow-up trend-arrow up"></i><span>+' + avgChange.toFixed(1) + ' PPM</span>';
        } else if (avgChange < 0) {
            avgTrend.innerHTML = '<i class="fas fa-arrow-down trend-arrow down"></i><span>' + avgChange.toFixed(1) + ' PPM</span>';
        } else {
            avgTrend.innerHTML = '<i class="fas fa-minus trend-arrow stable"></i><span>No change</span>';
        }
    }

    function updateHealthImpact(avgValue) {
        const healthImpact = document.getElementById('healthImpact');
        const title = document.getElementById('healthImpactTitle');
        const message = document.getElementById('healthImpactMessage');
        const recommendations = document.getElementById('healthImpactRecommendations');
        
        let riskLevel = 'low';
        let risk = healthRisks.low;
        
        if (avgValue > healthRisks.severe.threshold) {
            riskLevel = 'severe';
            risk = healthRisks.severe;
        } else if (avgValue > healthRisks.high.threshold) {
            riskLevel = 'high';
            risk = healthRisks.high;
        } else if (avgValue > healthRisks.moderate.threshold) {
            riskLevel = 'moderate';
            risk = healthRisks.moderate;
        }
        
        healthImpact.className = 'health-impact ' + riskLevel;
        title.textContent = risk.title;
        message.textContent = risk.message;
        
        // Clear and update recommendations
        recommendations.innerHTML = '';
        risk.recommendations.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recommendations.appendChild(li);
        });
    }

    function toggleReport() {
        const content = document.getElementById('reportContent');
        const toggle = document.getElementById('reportToggle');
        
        content.classList.toggle('expanded');
        toggle.classList.toggle('expanded');
    }

    // Fetch and update data
    async function updateData() {
        if (connectionState === 'connecting') {
            updateConnectionStatus('connecting');
        }

        try {
            // Fetch more data points for better analysis
            const response = await fetch(`https://api.thingspeak.com/channels/${CH_ID}/feeds.json?api_key=${READ_KEY}&results=100`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.feeds && data.feeds.length > 0) {
                processFeeds(data.feeds);
                updateMetrics();
                updateChart();
                generatePrediction();
                updateConnectionStatus('connected');
                retryCount = 0;
                hideDisconnectedOverlays();
                enableControls();
            } else {
                throw new Error('No data received from ThingSpeak');
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            updateConnectionStatus('disconnected');
            showDisconnectedOverlays();
            disableControls();
            handleRetry();
        }
    }

    function processFeeds(feeds) {
        historicalData = feeds
            .filter(feed => feed.field1 && !isNaN(parseFloat(feed.field1)))
            .map(feed => ({
                timestamp: new Date(feed.created_at),
                value: parseFloat(feed.field1),
                fire: feed.field2
            }))
            .reverse();
    }

    function updateMetrics() {
        if (historicalData.length === 0) return;

        const latest = historicalData[historicalData.length - 1];
        const gasValue = latest.value;
        
        // Update current value
        document.getElementById('currentGasValue').textContent = gasValue.toFixed(1);
        
        // Update status
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        if (gasValue > DANGER_THRESHOLD) {
            statusIndicator.className = 'status-indicator danger';
            statusText.textContent = 'Danger';
        } else if (gasValue > WARNING_THRESHOLD) {
            statusIndicator.className = 'status-indicator warning';
            statusText.textContent = 'Warning';
        } else {
            statusIndicator.className = 'status-indicator safe';
            statusText.textContent = 'Safe';
        }
        
        // Update health indicator
        updateHealthIndicator(gasValue);
        
        // Check for health alerts
        checkHealthAlert(gasValue);
        
        // Update last sync and update time
        const now = new Date();
        document.getElementById('lastSync').textContent = now.toLocaleTimeString();
        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
    }

    function updateHealthIndicator(value) {
        const healthIndicator = document.getElementById('healthIndicator');
        
        if (value > healthRisks.severe.threshold) {
            healthIndicator.className = 'health-indicator severe';
        } else if (value > healthRisks.high.threshold) {
            healthIndicator.className = 'health-indicator high';
        } else if (value > healthRisks.moderate.threshold) {
            healthIndicator.className = 'health-indicator moderate';
        } else {
            healthIndicator.className = 'health-indicator low';
        }
    }

    function checkHealthAlert(value) {
        let currentRiskLevel = 'low';
        
        if (value > healthRisks.severe.threshold) {
            currentRiskLevel = 'severe';
        } else if (value > healthRisks.high.threshold) {
            currentRiskLevel = 'high';
        } else if (value > healthRisks.moderate.threshold) {
            currentRiskLevel = 'moderate';
        }
        
        // Only show alert if risk level has changed
        if (currentRiskLevel !== lastHealthAlertLevel) {
            lastHealthAlertLevel = currentRiskLevel;
            showHealthPopup(currentRiskLevel);
        }
    }

    function showHealthPopup(riskLevel) {
        const popup = document.getElementById('healthPopup');
        const icon = document.getElementById('healthPopupIcon');
        const title = document.getElementById('healthPopupTitle');
        const message = document.getElementById('healthPopupMessage');
        const recommendations = document.getElementById('healthPopupRecommendations');
        
        const risk = healthRisks[riskLevel];
        
        icon.className = `health-popup-icon ${riskLevel}`;
        title.textContent = risk.title;
        message.textContent = risk.message;
        
        // Clear and update recommendations
        recommendations.innerHTML = '';
        risk.recommendations.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recommendations.appendChild(li);
        });
        
        popup.classList.add('active');
    }

    function showHealthDetails() {
        if (historicalData.length === 0) return;
        
        const latest = historicalData[historicalData.length - 1];
        const gasValue = latest.value;
        
        let riskLevel = 'low';
        
        if (gasValue > healthRisks.severe.threshold) {
            riskLevel = 'severe';
        } else if (gasValue > healthRisks.high.threshold) {
            riskLevel = 'high';
        } else if (gasValue > healthRisks.moderate.threshold) {
            riskLevel = 'moderate';
        }
        
        showHealthPopup(riskLevel);
    }

    function closeHealthPopup() {
        document.getElementById('healthPopup').classList.remove('active');
    }

    function updateChart() {
        if (!gasChart || historicalData.length === 0) return;
        
        // Get data from the last 6 hours but sample fewer points for better visibility
        const now = new Date();
        const sixHoursAgo = new Date(now.getTime() - 6 * 60 * 60 * 1000);
        const filteredData = historicalData.filter(d => d.timestamp >= sixHoursAgo);
        
        // Sample data to show fewer points with better spacing
        const sampledData = [];
        const step = Math.max(1, Math.floor(filteredData.length / 15)); // Show max 15 points
        
        for (let i = 0; i < filteredData.length; i += step) {
            sampledData.push(filteredData[i]);
        }
        
        // Make sure we include the latest data point
        if (sampledData[sampledData.length - 1] !== filteredData[filteredData.length - 1]) {
            sampledData.push(filteredData[filteredData.length - 1]);
        }
        
        // Update historical data
        gasChart.data.datasets[0].data = sampledData.map(d => ({
            x: d.timestamp,
            y: d.value
        }));
        
        // Update threshold lines
        gasChart.data.datasets[1].data = sampledData.map(d => ({
            x: d.timestamp,
            y: WARNING_THRESHOLD
        }));
        
        gasChart.data.datasets[2].data = sampledData.map(d => ({
            x: d.timestamp,
            y: DANGER_THRESHOLD
        }));
        
        gasChart.update();
    }

    function updateConnectionStatus(status) {
        connectionState = status;
        const statusElement = document.getElementById('connectionStatus');
        const pulseElement = document.getElementById('connectionPulse');
        const textElement = document.getElementById('connectionText');
        
        statusElement.className = 'connection-status ' + status;
        pulseElement.className = 'pulse ' + status;
        
        switch(status) {
            case 'connected':
                textElement.textContent = 'Connected';
                break;
            case 'connecting':
                textElement.textContent = 'Connecting...';
                break;
            case 'disconnected':
                textElement.textContent = 'Disconnected';
                break;
        }
    }

    function showDisconnectedOverlays() {
        document.getElementById('currentValueOverlay').style.display = 'flex';
        document.getElementById('predictionOverlay').style.display = 'flex';
        document.getElementById('riskOverlay').style.display = 'flex';
        document.getElementById('chartOverlay').style.display = 'flex';
        
        document.getElementById('currentValueCard').classList.add('disconnected');
        document.getElementById('predictionCard').classList.add('disconnected');
        document.getElementById('riskCard').classList.add('disconnected');
        document.getElementById('chartContainer').classList.add('disconnected');
    }

    function hideDisconnectedOverlays() {
        document.getElementById('currentValueOverlay').style.display = 'none';
        document.getElementById('predictionOverlay').style.display = 'none';
        document.getElementById('riskOverlay').style.display = 'none';
        document.getElementById('chartOverlay').style.display = 'none';
        
        document.getElementById('currentValueCard').classList.remove('disconnected');
        document.getElementById('predictionCard').classList.remove('disconnected');
        document.getElementById('riskCard').classList.remove('disconnected');
        document.getElementById('chartContainer').classList.remove('disconnected');
    }

    function disableControls() {
        document.getElementById('downloadBtn').disabled = true;
        document.getElementById('refreshBtn').disabled = true;
    }

    function enableControls() {
        document.getElementById('downloadBtn').disabled = false;
        document.getElementById('refreshBtn').disabled = false;
    }

    function handleRetry() {
        retryCount++;
        
        if (retryCount <= maxRetries) {
            const retrySeconds = 30;
            document.getElementById('connectionInfo').textContent = 
                `Connection attempt failed. Will retry automatically in ${retrySeconds} seconds.`;
            
            clearInterval(autoRetryInterval);
            autoRetryInterval = setTimeout(() => {
                updateData();
            }, retrySeconds * 1000);
        } else {
            document.getElementById('connectionInfo').textContent = 
                'Multiple connection attempts failed. Please check your connection and try manually.';
        }
    }

    function retryConnection() {
        retryCount = 0;
        updateConnectionStatus('connecting');
        updateData();
    }

    function downloadData() {
        if (historicalData.length === 0) {
            alert('No data available to download');
            return;
        }
        
        // Create CSV content
        let csvContent = "Timestamp,Gas Level (PPM),Fire Status\n";
        
        historicalData.forEach(data => {
            const timestamp = data.timestamp.toISOString();
            const gasLevel = data.value;
            const fireStatus = data.fire === "0" ? "Fire Detected" : "Safe";
            csvContent += `${timestamp},${gasLevel},${fireStatus}\n`;
        });
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `gas_data_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function refreshData() {
        updateConnectionStatus('connecting');
        updateData();
    }

    // Initialize
    initChart();
    updateData();
    
    // Update every 30 seconds
    setInterval(() => {
        if (connectionState === 'connected') {
            updateData();
        }
    }, 30000);
</script>

</body>
</html>
